import os
import matplotlib.pyplot as plt
import numpy as np

import matplotlib
matplotlib.rcParams['font.family'] = 'TakaoPGothic' # takao インストール後、matplotlibのフォルダ行ってキャッシュ削除
import datetime
current_time = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')


# リスト合成####################################################################

# cost1 = [[[1, 2], [3, 4]], [[5, 6], [7, 8]]]
# cost2 = [[[9, 10], [11, 12]], [[13, 14], [15, 16]]]

# array1 = np.array(cost1)
# array2 = np.array(cost2)
# combined_array = np.concatenate((array1, array2), axis=0)
# combined_list = combined_array.tolist()

##############################################################################


#inc(12~19)+trans(0~8)コスト行列
foldername = 'kanen877'
cost = [[[809566.8175120002, 0, 730122.848940638, 646920.625765717, 0, 0], [756324.3437846001, 0, 738130.8673332252, 663984.8110932702, 0, 0], [709089.3468057002, 0, 745138.2591216015, 678838.2013130018, 0, 0], [660503.0148175, 0, 754689.0785014355, 701399.7822935913, 0, 0], [614910.9121995001, 0, 761992.2611693472, 717068.6983114613, 0, 0], [576461.5278377, 0, 768191.5456108302, 728979.9877550538, 0, 0], [519292.51603350014, 0, 781244.0672855525, 759907.1705506545, 0, 0], [493432.7106531002, 0, 787509.8088506496, 772692.0502497772, 0, 0]], [[709075.9768530001, 55747.60793558, 728297.5929712323, 641771.7980416379, 6149.144388090442, 5949.146488839741], [604349.1856766001, 77806.35890460003, 737536.9785431438, 662391.891459865, 11980.387622496797, 11192.093445221002], [655394.8858707, 29172.790705399995, 734553.8607071745, 647360.8608452809, 9506.340379335852, 9179.11830583231], [613650.6153153, 33220.423210600005, 739122.4948020454, 657274.2743880887, 8901.14901254098, 8100.0350870924085], [550662.0812807003, 33220.423210600005, 752233.5518404023, 690291.6931643476, 8901.14901254098, 8100.0350870924085], [443974.90595740016, 64526.93423110001, 767296.5688918394, 726466.6016301388, 11599.468149468443, 10993.887560761617], [413049.63960960007, 67184.99356, 773799.4938349784, 739368.6406682706, 11648.917781337046, 11047.661262175374], [393467.03995759995, 67184.99356, 782442.4979017931, 758827.3257470445, 11648.917781337046, 11047.661262175374]], [[641328.6685756, 96201.57143336, 711986.710054316, 588038.8381081988, 19765.116672678712, 18702.590958805107], [542915.3449728002, 162352.54986966003, 716166.4993891808, 596811.4036956333, 23002.597167224907, 21826.10410251656], [569968.7502473, 96201.57143336, 722508.5852197333, 607060.0283073543, 19765.116672678712, 18702.590958805107], [450683.9768300001, 101896.56867098004, 748729.5103019258, 683583.1152998469, 18293.018372452054, 17221.280136363013], [418331.40955750004, 97747.3574417, 750681.6521535534, 685665.3159076982, 20500.617162009425, 19093.922647854026], [384433.7771863999, 101896.56867098004, 761041.5677361918, 707050.8957039793, 18293.018372452054, 17221.280136363013], [383359.7116030001, 85919.68249060003, 764141.5170664978, 711743.5852194884, 20957.307049071176, 19339.380121795864], [363266.38205559994, 85919.68249060003, 767897.9370947981, 718213.3420639473, 20957.307049071176, 19339.380121795864]], [[520705.2298172002, 129761.47104580002, 713687.3236095945, 599995.4950921667, 30189.92590277191, 27583.8473919339], [492786.7677918001, 116590.08697254003, 727974.897142893, 633397.9168372646, 26180.087543447957, 24820.31673172398], [519464.05898750015, 94224.48942144, 715665.2581474964, 599416.6812425161, 29106.054168673443, 27044.97100104905], [399457.24375260004, 123974.38488670003, 747674.3352183625, 679759.9816366847, 22759.006519376533, 22274.384197770458], [358868.4919096, 135116.99188158003, 744645.164624129, 666848.9671813049, 27194.167384993034, 25321.31522345542], [370776.8704372, 107997.49870632002, 754674.4553578936, 690305.2582021425, 25423.295195995655, 24392.484183203313], [373429.33702930016, 72495.06527774, 758461.6109276003, 699384.734016358, 25570.740100899773, 23715.967025792354], [361522.8943915, 67163.23809903998, 766248.3505110758, 714541.8090623566, 22874.093445567913, 21606.643237852448]], [[445966.94734870014, 153851.6808121801, 713420.8835190898, 598853.3308480494, 36502.556652727166, 33613.03408307591], [403776.8212189001, 196790.25177376004, 705757.3630814373, 566504.325783554, 40448.70219611477, 37107.3200449067], [382120.96427510004, 153851.6808121801, 726093.1128908303, 623277.6701333432, 36502.556652727166, 33613.03408307591], [365423.09984169994, 138559.86258802, 735194.4592342165, 644737.9298219443, 34274.99457666804, 32438.74556888196], [333643.9933976001, 153851.6808121801, 732827.6637966332, 633671.0321799405, 36502.556652727166, 33613.03408307591], [364619.9389444, 80485.45211210001, 753998.9446786625, 688400.6967887208, 30461.42179128142, 28974.65593892838], [339704.37955610006, 86296.23192828002, 753940.2832394125, 682519.8020401348, 32199.936001566064, 29912.26317667344], [318515.7217357001, 139579.89226176, 743498.1537333197, 655516.4603071739, 36121.85997279227, 34158.30179132764]], [[395583.85292820015, 175929.4970279001, 710277.4297349071, 589665.9098494356, 40968.544799651645, 38666.13814448335], [335723.00258160004, 209737.8545452601, 714785.8961433609, 590269.0901346424, 42326.17208045352, 40089.575710363744], [430101.66032200004, 130468.98541566, 705214.0286825486, 569961.313960081, 42105.67927193425, 38597.322594871235], [345394.82501420006, 120020.21176822003, 735936.4383741079, 648147.1436555369, 39660.448015042166, 37271.83702669916], [340752.5443477, 113705.8753227, 736601.7007579857, 645164.840667053, 39362.570803822404, 37074.69102602079], [295458.61725699995, 164489.93463924006, 734086.450370247, 634435.5600903493, 40590.78832880934, 38529.96950248686], [303893.6525444001, 112975.66909138001, 741747.270163986, 650823.9626464979, 41019.119952607725, 37950.8472398655], [304721.35497120005, 93771.17575412002, 747057.6436961993, 660913.2738578443, 40522.837609046226, 37684.61105000256]], [[310079.50618170004, 243402.68825866005, 698170.979405075, 549467.8044122016, 51227.321092994505, 48189.61079745615], [331398.6987869001, 186545.43586684007, 705502.7164570281, 565683.8682160707, 51359.8613074499, 47535.77091673865], [337401.74756240007, 140035.92857584, 722827.1915481177, 614039.9995680664, 46939.79538182998, 44525.59999447664], [320697.0330574001, 141977.15644651998, 718673.7252384161, 602017.6724275432, 49939.989339316024, 46762.054237877186], [302538.2415899001, 126823.97478650001, 742411.4161732818, 659115.3625245949, 41066.94507427445, 39968.10641330161], [295638.90881219995, 129710.49846314, 734074.9806406945, 634643.5657410652, 45374.13328777422, 42921.6419819693], [292885.55556039995, 107229.06292612001, 740401.5854927736, 646527.5981392923, 44785.17059443051, 42606.38015091388], [268232.6519716, 107229.06292612001, 747976.4207483302, 662166.3008852638, 44785.17059443051, 42606.38015091388]], [[324368.8253485, 212100.83318011998, 698174.1551630973, 549701.4820656748, 57198.57167517284, 54049.07264744943], [325421.3932063001, 173176.86491004002, 701496.8591890007, 562822.6361872684, 56265.637937828134, 52831.21993329763], [306513.72363350005, 156268.56827606002, 715549.2135031046, 588857.5377204783, 53612.1717267123, 50693.5759937671], [288143.3601255999, 162230.80065672004, 714211.0848705088, 580840.2244083729, 55387.95353415052, 51649.81703008896], [282888.51530549995, 136506.03223745996, 734102.5398173345, 631653.0171753657, 48973.3556995556, 47515.31000758601], [282539.8414165999, 138811.45648155996, 718292.0696957787, 592897.7981924025, 55483.73537122712, 52372.197759038216], [247555.2098169, 139038.79928288, 741909.1155983707, 648821.9689550678, 49284.441898909055, 47680.972730276444], [261673.37559310006, 99381.2507457, 755139.4592881749, 680871.1039743421, 45090.10712727833, 44218.33195487205]], [[267087.90571329993, 228672.29121990004, 694891.6521114364, 538742.7431227495, 60717.16010759141, 57925.37940502858], [247553.06160540003, 222575.7156752, 701536.5926226899, 552864.9662576907, 60635.19504609209, 57863.92838112823], [278191.55517989997, 180093.76603454, 703172.8594056303, 563590.4580499239, 60446.0058617131, 57691.53801030859], [257147.14061899998, 155452.93559716005, 725048.9923961695, 616989.106703528, 55037.402162644066, 53411.132919130236], [266347.15485469997, 145289.37683487998, 715782.4759034012, 589531.6623261132, 60883.00612683365, 57922.05724204696], [230552.5240379, 183939.55134668003, 719614.5535299556, 588336.3944909762, 59698.41739604405, 56604.69045583024], [221340.37843659997, 177818.95540106, 722041.0149802379, 591713.4396587056, 59744.03839531372, 56627.50095546507], [212587.86906150004, 175534.75254545998, 723303.0197911718, 600210.0514170293, 61538.24510550612, 58301.241829465376]]]

# cost = combined_list

horizon = "inc"
horizon = "trans"

##############################################################################

def bar_chart(cost_per_, N_START, filename):
    # コストデータを億単位に変換
    cost_per_ = cost_per_ / 1e4
    
    TC_direct = cost_per_[:, 0]
    TC_indirect = cost_per_[:, 1]
    IC_inc = cost_per_[:, 2]
    OC_inc = cost_per_[:, 3]
    IC_trans = cost_per_[:, 4]
    OC_trans = cost_per_[:, 5]

    plt.figure(figsize=(12, 6))
    N_FACILITY = np.arange(cost_per_.shape[0]) + N_START
    plt.xticks(N_FACILITY)
    plt.bar(N_FACILITY, TC_direct, color='blue', label='TC_direct')
    plt.bar(N_FACILITY, TC_indirect, bottom=TC_direct, color='blue', linestyle='--', label='TC_indirect')
    plt.bar(N_FACILITY, IC_trans, bottom=TC_direct + TC_indirect, color='yellow', label='IC_trans')
    plt.bar(N_FACILITY, OC_trans, bottom=TC_direct + TC_indirect + IC_trans, color='yellow', linestyle='--', label='OC_trans')
    plt.bar(N_FACILITY, IC_inc, bottom=TC_direct + TC_indirect + IC_trans + OC_trans , color='orange', label='IC_inc')
    plt.bar(N_FACILITY, OC_inc, bottom=TC_direct + TC_indirect + IC_trans + OC_trans + IC_inc, color='orange', linestyle='--', label='OC_inc')

    # 同色間点線の描画
    for x in range(cost_per_.shape[0]):
        adjusted_x = x + N_START  # 調整されたインデックス
        plt.hlines(TC_direct[x], adjusted_x - 0.4, adjusted_x + 0.4, colors='black', linestyles='dotted')
        plt.hlines(TC_direct[x] + TC_indirect[x] + IC_trans[x], adjusted_x - 0.4, adjusted_x + 0.4, colors='black', linestyles='dotted')
        plt.hlines(TC_direct[x] + TC_indirect[x] + IC_trans[x] + OC_trans[x] + IC_inc[x], adjusted_x - 0.4, adjusted_x + 0.4, colors='black', linestyles='dotted')

    # 凡例
    handles, labels = plt.gca().get_legend_handles_labels()
    # plt.legend(handles[::-1], labels[::-1], loc='upper left', bbox_to_anchor=(1.05, 1))        
    plt.legend(handles[::-1], labels[::-1], loc='lower left', bbox_to_anchor=(1, 0.4))        

    # ラベル
    plt.xlabel(xlabel)
    plt.ylabel('Cost (億円)')
    plt.title(f'Stacked Bar Chart for {title_suffix}')
    plt.tight_layout(rect=[0, 0, 0.85, 1])
    
    # ファイルに保存
    plt.savefig(filename)
    plt.close()  # グラフを閉じる

if horizon == "inc":
    save_folder = f"graphs_{str(foldername)}_INC_{current_time}"
    if not os.path.exists(save_folder):
        os.makedirs(save_folder)
    for N_TRANS in range(len(cost)):
        cost_per_inc = np.array(cost[N_TRANS])
        title_suffix = f'N_TRANS = {N_TRANS}'
        xlabel = 'N_INC'
        filename = os.path.join(save_folder, f'TRANS{N_TRANS}.png')
        bar_chart(cost_per_inc, 1, filename)

if horizon == "trans":
    save_folder = f"graphs_{str(foldername)}_TRANS_{current_time}"
    if not os.path.exists(save_folder):
        os.makedirs(save_folder)
    transposed_cost = np.transpose(cost, (1, 0, 2))
    for N_INC in range(len(transposed_cost)):
        cost_per_trans = np.array(transposed_cost[N_INC])
        title_suffix = f'N_INC = {N_INC+1}'
        xlabel = 'N_TRANS'
        filename = os.path.join(save_folder, f'INC{N_INC+1}.png')
        bar_chart(cost_per_trans, 0, filename)


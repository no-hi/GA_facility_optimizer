import os
import matplotlib.pyplot as plt
import numpy as np

import matplotlib
matplotlib.rcParams['font.family'] = 'TakaoPGothic' # takao インストール後、matplotlibのフォルダ行ってキャッシュ削除
import datetime
current_time = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')


# リスト合成####################################################################

# cost1 = [[[1, 2], [3, 4]], [[5, 6], [7, 8]]]
# cost2 = [[[9, 10], [11, 12]], [[13, 14], [15, 16]]]

# array1 = np.array(cost1)
# array2 = np.array(cost2)
# combined_array = np.concatenate((array1, array2), axis=0)
# combined_list = combined_array.tolist()

##############################################################################

#inc(1~13)+trans(0~8)コスト行列
foldername = 'kanen877'
cost = [[[9015179.901973303, 0, 533692.3115628922, 169092.3053423035, 0, 0], [5108678.148931402, 1509681.3104372602, 533692.3115628922, 169092.3053423035, 21711.39659063724, 22917.002518880265], [2731059.9527559006, 1785091.2845330397, 533692.3115628922, 169092.3053423035, 36743.26847379434, 37952.36782593827], [1310443.5715187003, 2170451.00551048, 533692.3115628922, 169092.3053423035, 53498.157266743736, 54610.40579611159], [1284610.0806110003, 1676167.4471713593, 533692.3115628922, 169092.3053423035, 60522.625296968916, 60284.50378492281], [338744.36606869986, 2127828.8858890994, 533692.3115628922, 169092.3053423035, 78558.80276203564, 79112.51769882604], [338744.36606869986, 1739566.0561591592, 533692.3115628922, 169092.3053423035, 84495.74068518763, 83480.986660402], [318043.4852119999, 1537297.3661803394, 533692.3115628922, 169092.3053423035, 90863.7382585764, 88125.11369257585], [318043.4852119999, 1379910.3698944398, 533692.3115628922, 169092.3053423035, 95349.4872599229, 93067.98819324911]], [[6375927.721536702, 0, 553344.0583633254, 198932.62407958158, 0, 0], [4097359.8965019993, 275409.97409578, 553728.7661616763, 201487.18920335808, 15031.871883157102, 15035.365307058004], [1700706.7656880012, 1638093.8498571403, 541984.6544666181, 169092.3053423035, 36158.03207060305, 36943.766084616596], [1384223.2325619005, 1393026.66764164, 554001.4855623196, 203328.78440132373, 47778.50249987841, 47978.08616939126], [438357.5180195999, 1846327.0260065796, 554001.4855623196, 203328.78440132373, 66037.94172578347, 66817.73096371365], [428321.06626169995, 1466440.4024273995, 553531.3039124779, 200170.33422018134, 72012.48609128364, 71232.67654920346], [646839.1914323998, 1064115.73368062, 542167.1270323105, 169092.3053423035, 74113.79398337984, 71428.18525032005], [460432.67094359995, 1095929.8356623405, 542167.1270323105, 169092.3053423035, 79276.30095885445, 76813.38767394776], [329494.86447699997, 1129150.25887294, 542167.1270323105, 169092.3053423035, 88177.44997139543, 84913.42276104016]], [[4100188.6146611, 0, 575545.8637164412, 251970.8330324258, 0, 0], [2877839.7444469007, 275409.97409578, 576233.8733646872, 252678.22362918104, 15031.871883157102, 15035.365307058004], [1925472.4107510007, 656599.2184411406, 576225.821768735, 256520.4765347733, 30115.558709768397, 30026.11271598009], [540236.6073194997, 1570917.0519108002, 576203.2909154354, 256366.99335416796, 51006.06984262637, 51782.365656655646], [530200.1555615999, 1191030.4283316203, 575733.1092655936, 253208.54317302557, 56980.61420812654, 56197.31124214546], [505539.0483394001, 993978.1068510002, 575710.8935885333, 253279.91012410723, 63352.74764547967, 60857.75227753435], [558351.533878, 825736.2300647602, 564346.7167083658, 222201.88124622943, 64262.28174156698, 61801.19477105747], [427413.7274114001, 858956.65327536, 564346.7167083658, 222201.88124622943, 73163.43075410796, 69901.22985814986], [393182.2567465, 804494.0476463999, 564420.8634566178, 222201.8812462294, 79908.89755078153, 76091.20852552773]], [[3035479.1525491998, 0, 598671.5251334719, 307062.0597896951, 0, 0], [1895306.4255702011, 609934.7538527, 598417.2608455843, 305633.08308018395, 15375.194704043417, 15223.02576188472], [1393703.9416101002, 596301.6143299805, 598503.8934480743, 306225.33932894666, 30768.244115823916, 31117.104848048944], [1186106.3754053002, 522469.18608067994, 586320.0981628688, 268733.6583534165, 34409.80359003186, 32842.75731282415], [701065.8763926999, 747297.6246179802, 597704.9491228272, 300038.91123128275, 49434.85288476648, 47855.6683097805], [646346.354091, 618718.2063196598, 598015.1439912969, 303987.8898002323, 51775.56697955596, 49557.70449361359], [515408.5476244002, 639335.1048714999, 598015.1439912969, 303987.8898002323, 60676.715992096935, 57657.739580705995], [568045.3179692001, 590098.1172876, 586245.731057215, 268328.64606414514, 63553.99392356079, 60315.7283327393], [477048.855105, 515950.70733043994, 598053.9764729072, 304246.0375528422, 72148.44544772642, 68228.76360276731]], [[2434289.6664103, 0, 621391.0680076589, 376322.193313915, 0, 0], [1350930.5291824006, 609934.7538527, 620455.0592255169, 352828.4833872154, 15375.194704043417, 15223.02576188472], [1328996.4331138004, 246606.38185259994, 620083.3455988714, 351150.84581557324, 22330.25397340509, 21540.496130812135], [1028279.7026330999, 327635.77245486, 620008.9784932175, 350745.8335263019, 32695.165243368167, 31170.418102232026], [841873.1821443001, 359449.87443658005, 620008.9784932175, 350745.8335263019, 37857.67221884277, 36555.62052585974], [587636.9465116002, 551279.7470655601, 607382.4421683961, 326394.3537577267, 55921.37416200661, 53213.76625251015], [621520.7927935001, 408466.92452549975, 621450.7698421951, 376845.3333012952, 55343.01612175115, 52557.01264827283], [531487.4177402, 419657.5530041801, 619649.9793845449, 347697.9650769507, 60632.01805368796, 57324.50556602206], [411300.28884970007, 475590.1836647, 619779.5926415742, 350290.1078284148, 69000.33036831784, 64414.810102515075]], [[1889913.770022501, 0, 643237.8277553574, 422722.8353395552, 0, 0], [1418597.4844396005, 122272.84281209999, 640309.1902324884, 411545.740650987, 12438.572883006906, 12182.019307256878], [1102659.0071642997, 205362.92964276005, 643286.198263753, 422845.75370854646, 20256.59236036126, 18988.39879497515], [916252.4866754999, 237177.03162448006, 643286.198263753, 422845.75370854646, 25419.099335835857, 24373.60121860286], [632392.8263846999, 484060.5523930201, 628922.4574085725, 369473.2501262913, 43938.74456688091, 41288.505477961], [599061.4980835002, 416603.80360104004, 629281.4565172453, 372521.11857564247, 47745.458643999584, 45219.59967816418], [493834.3951578001, 442928.38597078, 628922.4574085725, 369473.2501262913, 57243.83610279078, 54376.822498518675], [480618.2475606002, 353119.14734478004, 642212.5833176324, 417545.2138872857, 62522.773474184854, 58270.722741475984], [331701.3132497, 481215.9950874601, 628768.2430450703, 369310.78227213316, 73584.71727180642, 68283.25329891691]], [[1492976.7889708006, 0, 659890.1974796681, 468055.29752240644, 0, 0], [1192260.0584900999, 81029.39060226001, 659815.8303740143, 467650.2852331351, 10364.911269963075, 9629.921971419893], [948807.3948618001, 203302.23341435994, 649504.3623811593, 432903.6754403276, 22803.48415296998, 21811.94127867677], [802647.8416006, 238583.35285336003, 652558.6762877807, 444621.038757887, 29157.74137290224, 27088.433882067555], [693292.5168203999, 267756.14355876006, 652116.6640511197, 441227.2085052704, 38664.0817522381, 36267.55218789986], [636353.3677686, 230984.31443556005, 659373.8181373532, 464256.45498051855, 40084.05202540494, 38243.42427681206], [433701.21394770016, 398943.91770613997, 646417.3280346539, 433850.43397478043, 60341.88727667651, 56669.21550244785], [431653.8058801001, 339178.99576126, 647048.76565913, 443070.364054253, 62588.28810275886, 58329.90897411915], [346398.39689910004, 348513.17988932005, 659335.712735374, 464252.9640731625, 63364.86105139209, 59978.48048076453]], [[1252632.0057566003, 0, 678699.5367681609, 521750.4634546727, 0, 0], [993957.5953337001, 124333.5390405, 671442.3826819274, 498721.21697942464, 9891.681090398186, 9358.476823555256], [892248.8929264001, 114249.81381286001, 669085.369628339, 489413.23231174704, 19266.060282504055, 17729.9570585123], [782893.5681462, 143422.60451826005, 668643.3573916779, 486019.40205913037, 28772.400661839907, 26909.075364344608], [653686.5291603, 199170.2124538401, 668643.3573916779, 486019.40205913037, 34921.54504993035, 32858.22185318435], [471209.7019312001, 335124.4006885599, 663430.295786765, 469644.09262258606, 50446.51826313317, 46572.24618690905], [431287.8294828001, 330925.3437907001, 656813.6335134046, 464544.0577053996, 58383.8953167287, 54147.21409124106], [366569.32112630014, 310677.71848736, 668355.4447083168, 485315.163210404, 57907.922963997706, 54528.606970218025], [352658.1243683, 288774.6079931401, 665366.9592379476, 488006.1499965666, 63001.99572967551, 59782.2777552487]], [[1083558.6466595, 0, 687969.0760224856, 543513.4105332847, 0, 0], [852830.1416968001, 159675.6231341, 682706.7769872793, 531157.4959282111, 14266.66139329511, 13870.16385829139], [843265.5154127001, 62393.21391599999, 688184.4917941622, 542907.6248723221, 18407.489391876832, 17279.153392924716], [684414.8855922, 160775.29749412002, 685406.7803337458, 527368.8764999324, 25983.182761156793, 24720.716364687985], [543944.6640868001, 228143.55462392003, 685518.0857384684, 528344.120301813, 37765.61927205187, 35025.41036369716], [484161.7088802001, 234881.07141444006, 678245.9097076316, 507856.97794324375, 46867.46792269024, 43242.9560544958], [410865.0366438002, 274410.4344099, 676241.2997822455, 503342.8189311208, 51489.15723742224, 48392.970960628925], [400252.5699704, 233027.00005756013, 675122.9563466281, 510002.9944498272, 56852.85134158507, 53833.131266408964], [372433.5901769, 255175.44991336, 665686.5317120163, 483920.18293319293, 66524.414231171, 62354.69258627042]], [[1001946.0532757002, 0, 697725.0731311662, 565510.2549865451, 0, 0], [892590.7284955002, 29172.790705399995, 697940.4889028427, 564904.4693255825, 9506.340379335852, 9179.11830583231], [741318.2013887003, 90211.16055224002, 695917.1456013893, 562518.5383838055, 19674.573271781595, 17942.87668958943], [646473.8177972, 143422.60451826005, 687687.4845325655, 530191.4698161354, 28772.400661839907, 26909.075364344608], [516454.74854990013, 196486.15645472007, 695084.9200099566, 549414.9691093281, 37929.10563391668, 35105.45056599944], [429354.55191500013, 235810.65571068, 687509.9774046632, 529786.8022556738, 46922.39050674517, 43270.41734652327], [382739.7048766001, 254930.11055178003, 682267.2309983723, 513976.4797298936, 51758.778575907265, 48579.460481378286], [382739.7048766001, 220595.08487848, 682259.9115352699, 514243.3971968681, 56357.30693728715, 52978.72466206823], [334420.1301538, 235863.44054957997, 682355.0905288158, 514625.088167456, 62384.313440309656, 59450.24816125071]], [[896651.7432090001, 0, 714339.9898694521, 606311.5407089858, 0, 0], [787296.4184288001, 29172.790705399995, 714555.4056411285, 605705.7550480232, 9506.340379335852, 9179.11830583231], [694492.9311799001, 96201.57143336, 702418.0700501323, 565116.7864477484, 19765.116672678712, 18702.590958805107], [614120.4889379002, 129421.99464396, 695294.5160627177, 547021.383787386, 28666.265685219692, 26802.626045897516], [477373.6652977001, 188589.62262578006, 702261.2020431837, 564804.6416147687, 37915.106517583976, 35063.93294098377], [438525.7962534001, 185434.0743676201, 691544.2302621298, 545696.947816607, 47201.12142952377, 43378.85169120024], [358053.0963361001, 225637.68245332, 697011.4872392525, 551269.4075252208, 49425.08152322793, 47298.722648737246], [386578.01859510015, 173176.86491004002, 688316.1797615322, 536560.2756865957, 56265.63793782813, 52831.21993329763], [305459.07895200007, 228672.29121990004, 688799.3649938973, 527219.1823559023, 60717.16010759141, 57925.37940502858]], [[841844.5862438001, 0, 722926.211130409, 625553.6325781805, 0, 0], [732489.2614636002, 29172.790705399995, 723313.4024841108, 625626.8299609481, 9506.340379335852, 9179.11830583231], [578705.6892767004, 111026.78211520003, 720922.0618048579, 621590.6057374245, 20881.536635037777, 19292.12853231341], [522348.1241781002, 129761.47104580002, 713983.11448913, 600811.0208903049, 30189.92590277191, 27583.8473919339], [445620.8686782001, 153851.6808121801, 713498.1607724022, 599069.4994464214, 36502.556652727166, 33613.03408307591], [453541.5295213001, 156521.13313614, 695880.437785131, 553108.5139531521, 43190.522162732246, 39976.2460676675], [372685.712154, 180734.65605066, 703052.1664975578, 564931.4213855399, 49621.347097165264, 46598.16367899359], [341730.87503249996, 179491.20135555998, 695400.1376467416, 551913.3592716564, 56563.5151490479, 53028.365933976005], [296803.57796719996, 202013.42807408003, 694374.5275134313, 548175.0427872109, 61029.503295972376, 58081.46999538345]], [[756670.4224551002, 0, 738053.5900799128, 663768.6424948983, 0, 0], [683445.8504058002, 33220.423210600005, 728523.3423833156, 638036.9155905612, 8901.14901254098, 8100.0350870924085], [534600.0587734001, 111026.78211520003, 728084.0080998591, 636876.3331538999, 20881.536635037777, 19292.12853231341], [467791.49085750006, 163569.82856316003, 715929.0400839649, 594733.2358242199, 31547.55318357379, 29007.284957814292], [415956.4349739001, 152691.44293206005, 717576.6727004647, 605517.8029142786, 37892.732161789645, 35087.13283157976], [327205.98796520004, 220880.4615401401, 705688.7359968558, 565919.054676811, 46761.332946070026, 43136.50673604871], [284136.17637369985, 240929.50067748007, 702198.7034160622, 554329.7516106255, 51652.643599287054, 48473.011162931194], [324278.2251972001, 169349.39777007993, 705879.3633810269, 576536.9253153432, 54523.23285267639, 51891.077765516275], [282278.69089989987, 184157.16430796002, 704242.4200038477, 561148.158680748, 59816.67408392142, 56684.28729291961]]]

# cost = combined_list

horizon = "inc"
horizon = "trans"

##############################################################################

def bar_chart(cost_per_, N_START, filename):
    # コストデータを億単位に変換
    cost_per_ = cost_per_ / 1e4
    
    TC_direct = cost_per_[:, 0]
    TC_indirect = cost_per_[:, 1]
    IC_inc = cost_per_[:, 2]
    OC_inc = cost_per_[:, 3]
    IC_trans = cost_per_[:, 4]
    OC_trans = cost_per_[:, 5]

    plt.figure(figsize=(12, 6))
    N_FACILITY = np.arange(cost_per_.shape[0]) + N_START
    plt.xticks(N_FACILITY)
    plt.bar(N_FACILITY, TC_direct, color='blue', label='TC_direct')
    plt.bar(N_FACILITY, TC_indirect, bottom=TC_direct, color='blue', linestyle='--', label='TC_indirect')
    plt.bar(N_FACILITY, IC_trans, bottom=TC_direct + TC_indirect, color='yellow', label='IC_trans')
    plt.bar(N_FACILITY, OC_trans, bottom=TC_direct + TC_indirect + IC_trans, color='yellow', linestyle='--', label='OC_trans')
    plt.bar(N_FACILITY, IC_inc, bottom=TC_direct + TC_indirect + IC_trans + OC_trans , color='orange', label='IC_inc')
    plt.bar(N_FACILITY, OC_inc, bottom=TC_direct + TC_indirect + IC_trans + OC_trans + IC_inc, color='orange', linestyle='--', label='OC_inc')

    # 同色間点線の描画
    for x in range(cost_per_.shape[0]):
        adjusted_x = x + N_START  # 調整されたインデックス
        plt.hlines(TC_direct[x], adjusted_x - 0.4, adjusted_x + 0.4, colors='black', linestyles='dotted')
        plt.hlines(TC_direct[x] + TC_indirect[x] + IC_trans[x], adjusted_x - 0.4, adjusted_x + 0.4, colors='black', linestyles='dotted')
        plt.hlines(TC_direct[x] + TC_indirect[x] + IC_trans[x] + OC_trans[x] + IC_inc[x], adjusted_x - 0.4, adjusted_x + 0.4, colors='black', linestyles='dotted')

    # 凡例
    handles, labels = plt.gca().get_legend_handles_labels()
    # plt.legend(handles[::-1], labels[::-1], loc='upper left', bbox_to_anchor=(1.05, 1))        
    plt.legend(handles[::-1], labels[::-1], loc='lower left', bbox_to_anchor=(1, 0.4))        

    # ラベル
    plt.xlabel(xlabel)
    plt.ylabel('Cost (億円)')
    plt.title(f'Stacked Bar Chart for {title_suffix}')
    plt.tight_layout(rect=[0, 0, 0.85, 1])
    
    # ファイルに保存
    plt.savefig(filename)
    plt.close()  # グラフを閉じる

if horizon == "trans":
    save_folder = f"graphs_{str(foldername)}_TRANS_{current_time}"
    if not os.path.exists(save_folder):
        os.makedirs(save_folder)
    for N_TRANS in range(len(cost)):
        cost_per_inc = np.array(cost[N_TRANS])
        title_suffix = f'N_INC = {N_TRANS+1}'
        xlabel = 'N_TRANS'
        filename = os.path.join(save_folder, f'INC{N_TRANS+1}.png')
        bar_chart(cost_per_inc, 0, filename)

if horizon == "inc":
    save_folder = f"graphs_{str(foldername)}_INC_{current_time}"
    if not os.path.exists(save_folder):
        os.makedirs(save_folder)
    transposed_cost = np.transpose(cost, (1, 0, 2))
    for N_INC in range(len(transposed_cost)):
        cost_per_trans = np.array(transposed_cost[N_INC])
        title_suffix = f'N_TRANS = {N_INC}'
        xlabel = 'N_INC'
        filename = os.path.join(save_folder, f'TRANS{N_INC}.png')
        bar_chart(cost_per_trans, 1, filename)


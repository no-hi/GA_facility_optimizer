import os
import matplotlib.pyplot as plt
import numpy as np

import matplotlib
matplotlib.rcParams['font.family'] = 'TakaoPGothic' # takao インストール後、matplotlibのフォルダ行ってキャッシュ削除
import datetime
current_time = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')

##############################################################################

#inc(1~15)+trans(0~8)コスト行列
foldername = 'kanen1000'
cost = [[[10279566.592899997, 0, 329899.8818864615, 138135.64307217477, 0, 0], [7270157.037099997, 0, 342047.53477158566, 162512.92984408402, 0, 0], [4675243.574299999, 0, 355771.4966967819, 205841.14094314096, 0, 0], [3397626.948399999, 0, 369920.74918130506, 249747.23673534326, 0, 0], [2775700.8738999995, 0, 384110.53616400325, 307426.8108801027, 0, 0], [2154975.7925000004, 0, 397615.02799237816, 345332.6310899478, 0, 0], [1702368.0604000005, 0, 407908.6272932413, 382365.82904059737, 0, 0], [1428314.7158000006, 0, 419535.5491641308, 426230.7243763468, 0, 0], [1235528.6735, 0, 425265.47976063576, 444009.4085321045, 0, 0], [1115466.7463999994, 0, 435535.9276399808, 477340.97752355796, 0, 0], [1024192.0483999993, 0, 441614.3289590457, 495487.33158884966, 0, 0], [923109.2559999992, 0, 451322.6748999898, 528485.2937329033, 0, 0], [841263.1711999994, 0, 461239.4736901477, 561679.1241610616, 0, 0], [770024.9065999996, 0, 468561.4977708982, 582842.4090602223, 0, 0], [728477.7806999995, 0, 470568.96128822805, 587929.9662847838, 0, 0]], [[5859089.5715999985, 2176825.4986799997, 329899.8818864615, 138135.64307217477, 18407.416947187252, 22588.746776677886], [4565226.451099999, 662050.60606, 342047.53477158566, 162512.92984408402, 12552.950329518353, 13239.734189794002], [2994257.4976999997, 709443.8524799999, 356077.1960905506, 208531.12068446877, 14206.608283825135, 15328.18754707108], [2690767.4584, 241258.30867999996, 369930.34316077264, 249804.62331635624, 10200.779053570008, 9987.191148422415], [2094787.8004, 212684.25739999994, 383562.73598675954, 288418.8254328009, 10024.903252495755, 9155.589763253389], [1561101.0653000004, 285251.4697, 396066.50681753136, 337507.5716862545, 9777.273246884448, 8972.149572025764], [1359475.5513000002, 134837.38602, 407862.65754842793, 382034.964588088, 8420.187055809867, 7308.945619537028], [1216342.0914, 64865.85155999999, 419535.5491641308, 426230.7243763468, 3937.6503953894853, 3450.322216152802], [1086226.7276999995, 53447.452600000004, 425265.47976063576, 444009.4085321045, 7103.769440475324, 5754.127523380359], [986928.0666999992, 53447.452600000004, 435021.5943431508, 477183.9640952831, 7103.769440475324, 5754.127523380359], [878399.1986999993, 69890.17124, 445292.04222249595, 510515.5330867365, 4612.372585875564, 3725.3539666842566], [796553.1138999994, 69890.17124, 455208.8410126538, 543709.3635148949, 4612.372585875564, 3725.3539666842566], [754806.3301999995, 47368.85544000001, 455968.81517009466, 541715.1543579194, 5987.078752633861, 4404.83248369805], [638352.4567999997, 86366.81049999999, 463405.3960705016, 565564.7827160698, 9462.795232988003, 8742.427133179182], [659702.6932999996, 30087.644279999997, 467189.07304219395, 575672.4254904237, 5513.4827011989655, 4154.355239034076]], [[3154158.9856000007, 2838876.104739999, 329899.8818864615, 138135.64307217477, 30960.367276705605, 35828.48096647189], [3015051.9642, 1315965.6310399997, 342220.0310611881, 164022.9295050398, 26502.510907953983, 28348.11864673769], [2118719.6648999997, 1170841.95962, 356177.88283088605, 209432.47191389627, 25115.110045271143, 26577.37325645661], [1612243.2684999998, 861294.8531799999, 369983.3391184432, 250284.98451433284, 25521.220370166862, 27699.60269374631], [1440732.0405000001, 529661.24434, 383315.4161380479, 286942.6051306508, 17940.4978584933, 16123.607761832147], [1259899.5258999998, 345174.50732000003, 397643.6908227209, 345426.1583980221, 16390.917148255, 14316.352694768124], [1147502.9268999998, 199703.23758, 407862.65754842793, 382034.964588088, 12357.837451199353, 10759.267835689829], [1067040.1455999997, 118313.30416000001, 419535.5491641308, 426230.7243763468, 11041.41983586481, 9204.44973953316], [963018.5572999992, 99379.01180000001, 425398.63820435485, 443514.5273979715, 14758.091143600854, 12555.09253679643], [850454.5136999993, 122826.49759999997, 435669.0860837, 476846.09638942487, 12369.11455359659, 10571.688312527349], [770411.4325999995, 117259.02668000001, 445035.82488235715, 509981.8364601975, 10599.451338509425, 8130.186450382307], [667241.8720999996, 140236.49209999997, 450905.7143351424, 526675.8731467166, 14694.975914553486, 12776.430161776309], [610896.5694999995, 139814.26309999998, 453182.7168327274, 532409.8071437415, 16566.564673463326, 14496.554656559541], [552761.5304999999, 140236.49209999997, 460322.5066624308, 553239.7514181477, 14694.975914553486, 12776.430161776309], [593963.2405999997, 64124.26018, 465316.54421352927, 568575.8060342927, 13291.353342646005, 11040.499303448774]], [[1531002.4268999998, 3457884.3689399986, 329899.8818864615, 138135.64307217477, 44920.23463339729, 50911.96770637164], [2008702.5416999992, 1832892.5656800002, 342453.92090568977, 166104.26081483933, 37668.06037478949, 39817.10744625061], [1159339.2037, 1626899.6189199993, 356231.6899337376, 209917.89639147551, 40042.931363554955, 43990.991545199744], [1061069.362, 1069698.2469, 369767.0834656226, 248994.6640606373, 33478.66877660848, 34697.09218620311], [1116873.0778999997, 646118.4767400001, 384172.60533121147, 307915.18677759805, 28233.285817766955, 26279.744134720382], [1088203.4955, 410453.76739999995, 395828.1675506617, 336221.4191097864, 22369.427794518306, 19904.94001492], [998200.9810999994, 253150.69018, 407862.65754842793, 382034.964588088, 19461.606891674677, 16513.39535907019], [894179.3927999991, 234216.39782, 413319.3599542552, 397041.1457403888, 23178.27819941072, 19864.03815633346], [825249.6705999993, 169269.18304, 425398.63820435485, 443514.5273979715, 19370.463729476418, 16280.446503480687], [694318.3990999996, 205676.86983999997, 435636.5247822831, 477069.17859013367, 21763.093028881056, 18621.35706399513], [647294.5300999996, 189234.15119999996, 436783.75579360774, 477840.31445573596, 24254.489883480815, 20650.130620691234], [609010.9403999997, 168147.83497999999, 446186.9829622512, 507800.86896876525, 21019.75897826147, 18320.79143638653], [612232.1779999996, 96485.39656, 458391.744157271, 551605.3672412517, 17160.391877901984, 14465.28764252443], [504975.2666, 166720.76966, 458280.95255933417, 545474.5657007059, 17894.23986927452, 15977.389880827648], [526016.3674999999, 93750.84198, 465716.7141966895, 570162.9265066405, 16593.767398386753, 14272.831978093196]], [[1497794.8744999997, 2954466.065199999, 329899.8818864615, 138135.64307217477, 50303.58328384963, 53143.777390454634], [1049322.0805, 2288950.224980001, 342507.7280085414, 166589.68529241858, 52595.88169307331, 57230.72573499374], [698469.4207, 1725935.387559999, 355945.99117306364, 207368.74595199246, 47475.47708233785, 49831.00966565863], [1032949.5133999997, 883345.0555599999, 369753.3509289541, 249052.9654698103, 38412.29428260602, 36257.0173608124], [885866.9069999999, 729364.48192, 383269.4463932345, 286611.7406781414, 30298.33530969265, 26882.875597521976], [938901.5496999995, 463901.22000000003, 395828.1675506617, 336221.4191097864, 29473.19723499363, 25659.06753830036], [882577.9893999995, 308382.17425999994, 405985.82913820393, 382737.40855757846, 28021.885095617254, 24649.86157786958], [756410.5060999992, 304106.56906, 413319.3599542552, 397041.1457403888, 27790.650785286285, 23589.392123017715], [665078.3803999996, 259124.32243999996, 425366.07690293796, 443737.6095986803, 28866.86246935638, 24375.48458737549], [623192.5951999997, 227165.35729999997, 431232.01064720197, 460774.30831730523, 29170.07737297301, 24452.723117067522], [572617.4005000001, 207593.92018, 441460.0806704056, 493890.8926022226, 25935.346467753665, 22123.383932762823], [520571.19519999996, 226045.08107999997, 443170.3335965869, 498678.2197639869, 25667.78389028479, 21955.346024232324], [537892.5009999999, 159047.37872, 448054.2162751252, 512593.6897555825, 25253.978316760917, 20630.69589447514], [458331.86209999997, 182526.45175999997, 458252.2460984068, 545336.370055025, 20920.189537104714, 19131.43009032121], [476084.62300000014, 121376.14484, 465328.2852407124, 568702.0803813433, 19854.815615679254, 17493.135935638325]], [[419270.68460000004, 3572502.68078, 329899.8818864615, 138135.64307217477, 65625.04267419393, 70856.18897650148], [588452.2974999999, 2387985.993620001, 342222.0292478674, 164040.53485293555, 60028.4274118562, 63070.74385545264], [670349.5720999999, 1539582.196219999, 355932.2586363951, 207427.04736116546, 52409.10258833539, 51390.934840267924], [742840.4589999997, 1030308.4513399998, 369674.28943118, 248415.60272399426, 42140.703979204605, 38846.26703747424], [863464.7452999996, 649767.4498999999, 384146.2034107004, 307847.28902438225, 37309.03280339693, 33212.086749257345], [775416.7852999994, 509419.37068, 397370.4626320433, 342653.6553945652, 35086.65868724534, 30321.767447717357], [737223.9239999994, 368972.42062, 407589.4293577503, 379262.461584631, 31728.30118067577, 27039.714339170518], [645891.7982999996, 323990.174, 419640.59926592896, 425983.60971323814, 32804.51286474586, 27825.806803528292], [556137.5620999997, 362002.7433200001, 419302.9099556226, 415057.38941315963, 37590.26442878287, 31761.66873660455], [543377.3818, 259526.49367999999, 431189.63279106043, 460559.32361076924, 33039.11590822899, 27877.51145614318], [496029.3869000001, 252529.35863999996, 440600.98079555423, 493177.8011930047, 28867.047845005825, 25156.305743283665], [509586.2743, 188673.96052000002, 445448.5457226187, 506918.27656801546, 28556.392372501665, 23863.02856911956], [487511.98300000007, 169283.68495999996, 451368.4073496123, 523559.51038537733, 28046.570553982194, 23685.837589397503], [466637.006, 142693.01729999998, 455886.4359345296, 536537.6442715303, 27461.062012607625, 23510.120589877766], [412941.7040000002, 180771.74302000002, 456287.7472690274, 534728.7456786699, 28459.904042408172, 23819.066147942518]], [[419270.68460000004, 3147607.8922000006, 329899.8818864615, 138135.64307217477, 70093.09616520822, 72256.36769864113], [485418.9617000001, 2286238.5858400017, 342163.2798989012, 163524.0455531199, 64702.15676248248, 63729.99659202392], [597071.0288999998, 1460909.4017600003, 355873.5092874289, 206910.55806134982, 55372.21906993072, 52590.391322735406], [778519.9864999996, 886994.0287199997, 369756.76105590246, 249140.98374693497, 47501.23562647791, 43189.360503123695], [714162.7994999997, 703214.9025000001, 384146.2034107004, 307847.28902438225, 44412.802243872255, 38966.2142726377], [633612.7229999994, 585976.86308, 397370.4626320433, 342653.6553945652, 39817.580941603155, 34092.49139200479], [577052.6337999997, 458827.5600200001, 407663.72993277863, 380090.09738996765, 41224.69992055573, 35134.75242306532], [534439.4256000001, 429104.17284, 417969.2962029374, 413552.55336442014, 37912.43882083566, 32752.730197278863], [498667.32449999993, 329416.66492, 425159.0001135666, 442589.56296460243, 37651.48849410455, 31602.865422827435], [543377.3818, 224952.75797999997, 431185.10829265445, 460777.3750228253, 36500.88741991206, 29977.649927003647], [441624.39690000005, 289153.0754800001, 433673.9642951055, 465596.0577157433, 36341.52996396973, 31109.844130787602], [470864.4156, 201131.88718000002, 443939.88767604466, 499145.6781192529, 32699.532035177486, 27455.855078267712], [420933.8915000001, 210964.80209999997, 447929.04804839235, 511990.6032560844, 31685.085991756434, 27051.747401795838], [417371.25030000013, 178291.82441999996, 453394.5171200981, 525958.0772916602, 31650.14296571227, 27122.361037499453], [381810.1071000002, 190290.34193999995, 452213.62806105963, 517647.48131571384, 35517.49367429153, 29568.901468514097]], [[389515.892, 2961254.700860001, 329899.8818864615, 138135.64307217477, 75026.72167120576, 73816.29287325041], [485418.9617000001, 2122960.007820001, 342163.2798989012, 163524.0455531199, 67925.16939944908, 65830.12551252941], [633621.0723999998, 1316879.8185599993, 355955.93451302114, 207635.8601343522, 60731.97182207195, 56934.61009640714], [629218.0406999998, 940441.4813199999, 369756.76105590246, 249140.98374693497, 54605.00506695322, 48943.488026504056], [577448.5631999997, 790060.07174, 383055.974739316, 284173.6670618507, 49710.62161643986, 43192.79359363178], [571226.7548999997, 607948.2302, 394378.9597852676, 344981.903039945, 46991.801623926964, 39329.630017270436], [493202.2447999999, 498193.46356, 407580.6091152652, 379644.89782945235, 45196.158720407206, 38604.910094568], [429828.16000000003, 465768.9300400001, 413141.38781904435, 396465.8357873527, 46071.67554991442, 38911.81104236446], [432745.65300000005, 359043.24672000017, 425074.4462685503, 442181.92671374354, 40953.9025498453, 34835.19809747186], [477455.71030000004, 254579.33978, 431100.55444763816, 460369.7387719664, 39803.301475652814, 33209.982601648066], [445388.8153, 251437.03553999995, 433705.7575481735, 465989.10374438437, 39700.1513746331, 33178.60964605499], [416066.7166000001, 234881.58125999998, 439106.333697968, 482198.05954092427, 38857.06250720731, 32907.86151647289], [410074.0130000001, 191712.75739999997, 449302.0617385255, 515271.56771250756, 35355.20820116956, 30483.6314877801], [351631.33010000014, 230769.66685999994, 446849.7253017811, 501879.2001640401, 38962.95316730279, 32919.541146071904], [343218.24920000014, 191643.76786, 457120.17318112624, 535210.7691554935, 36137.0359695793, 30749.10213952098]], [[389515.892, 2805805.280960001, 329899.8818864615, 138135.64307217477, 78249.73430817234, 75916.4217937559], [521969.00519999996, 1978930.4246199995, 342245.7051244934, 164249.3476261223, 73284.9221515903, 70174.34428620114], [484319.12659999984, 1370327.2711599993, 355955.93451302114, 207635.8601343522, 67835.74126254728, 62688.7376197875], [491449.15399999986, 1010331.6525600001, 369756.76105590246, 249140.98374693497, 59217.3776528288, 52668.84199318831], [417277.2729999998, 879915.21114, 383131.47011562466, 285008.37219770224, 59207.020356319816, 51287.831677526585], [397661.395, 701525.8177000001, 397361.79790819186, 343036.9657726671, 53064.468548256846, 45566.94783737207], [410323.40510000003, 530634.7816000002, 407565.8746477801, 379259.60977696563, 50009.325945303906, 42362.133258517264], [373408.76360000006, 483299.5950800001, 413204.22756897, 396820.57806226163, 49332.8019443886, 42070.010347146264], [432745.65300000005, 324469.51102, 425069.9217701443, 442399.9781257996, 44415.67406152838, 36935.33656833232], [442178.2737000001, 261991.65338, 431148.32308920915, 460546.3321910914, 42765.192761076185, 36343.20147401181], [402509.82920000004, 264100.41339999996, 433713.22738012456, 466025.12524008413, 42622.950941443574, 36301.27689995547], [380833.99430000014, 245160.20999999996, 439031.61385918036, 481939.9987210542, 42458.97764164489, 36237.75901116046], [340478.28810000006, 248465.14513999998, 443001.9071912378, 492171.5655867759, 43836.375456432994, 36707.92454871689], [317877.2904, 226614.66996, 451841.82657490496, 522078.37547104317, 39590.3452164635, 33951.47869435661], [314134.56480000005, 204140.76279999997, 457177.19186432916, 535458.387996162, 39082.53591184359, 33868.88661979264]]]

horizon = "inc"
horizon = "trans"

##############################################################################

def bar_chart(cost_per_, N_START, filename):
    # コストデータを億単位に変換
    cost_per_ = cost_per_ / 1e4
    
    TC_direct = cost_per_[:, 0]
    TC_indirect = cost_per_[:, 1]
    IC_inc = cost_per_[:, 2]
    OC_inc = cost_per_[:, 3]
    IC_trans = cost_per_[:, 4]
    OC_trans = cost_per_[:, 5]

    plt.figure(figsize=(12, 6))
    N_FACILITY = np.arange(cost_per_.shape[0]) + N_START
    plt.xticks(N_FACILITY)
    plt.bar(N_FACILITY, TC_direct, color='blue', label='TC_direct')
    plt.bar(N_FACILITY, TC_indirect, bottom=TC_direct, color='blue', linestyle='--', label='TC_indirect')
    plt.bar(N_FACILITY, IC_inc, bottom=TC_direct + TC_indirect, color='orange', label='IC_inc')
    plt.bar(N_FACILITY, OC_inc, bottom=TC_direct + TC_indirect + IC_inc, color='orange', linestyle='--', label='OC_inc')
    plt.bar(N_FACILITY, IC_trans, bottom=TC_direct + TC_indirect + IC_inc + OC_inc, color='yellow', label='IC_trans')
    plt.bar(N_FACILITY, OC_trans, bottom=TC_direct + TC_indirect + IC_inc + OC_inc + IC_trans, color='yellow', linestyle='--', label='OC_trans')

    # 同色間点線の描画
    for x in range(cost_per_.shape[0]):
        adjusted_x = x + N_START  # 調整されたインデックス
        plt.hlines(TC_direct[x], adjusted_x - 0.4, adjusted_x + 0.4, colors='black', linestyles='dotted')
        plt.hlines(TC_direct[x] + TC_indirect[x] + IC_inc[x], adjusted_x - 0.4, adjusted_x + 0.4, colors='black', linestyles='dotted')
        plt.hlines(TC_direct[x] + TC_indirect[x] + IC_inc[x] + OC_inc[x] + IC_trans[x], adjusted_x - 0.4, adjusted_x + 0.4, colors='black', linestyles='dotted')

    # 凡例
    handles, labels = plt.gca().get_legend_handles_labels()
    # plt.legend(handles[::-1], labels[::-1], loc='upper left', bbox_to_anchor=(1.05, 1))        
    plt.legend(handles[::-1], labels[::-1], loc='lower left', bbox_to_anchor=(1, 0.4))        

    # ラベル
    plt.xlabel(xlabel)
    plt.ylabel('Cost (億円)')
    plt.title(f'Stacked Bar Chart for {title_suffix}')
    plt.tight_layout(rect=[0, 0, 0.85, 1])
    
    # ファイルに保存
    plt.savefig(filename)
    plt.close()  # グラフを閉じる

if horizon == "inc":
    save_folder = f"graphs_{str(foldername)}_INC_{current_time}"
    if not os.path.exists(save_folder):
        os.makedirs(save_folder)
    for N_TRANS in range(len(cost)):
        cost_per_inc = np.array(cost[N_TRANS])
        title_suffix = f'N_TRANS = {N_TRANS}'
        xlabel = 'N_INC'
        filename = os.path.join(save_folder, f'TRANS{N_TRANS}.png')
        bar_chart(cost_per_inc, 1, filename)

if horizon == "trans":
    save_folder = f"graphs_{str(foldername)}_TRANS_{current_time}"
    if not os.path.exists(save_folder):
        os.makedirs(save_folder)
    transposed_cost = np.transpose(cost, (1, 0, 2))
    for N_INC in range(len(transposed_cost)):
        cost_per_trans = np.array(transposed_cost[N_INC])
        title_suffix = f'N_INC = {N_INC+1}'
        xlabel = 'N_TRANS'
        filename = os.path.join(save_folder, f'INC{N_INC+1}.png')
        bar_chart(cost_per_trans, 0, filename)

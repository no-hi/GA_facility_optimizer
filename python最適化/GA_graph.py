import os
import matplotlib.pyplot as plt
import numpy as np

import matplotlib
matplotlib.rcParams['font.family'] = 'TakaoPGothic' # takao インストール後、matplotlibのフォルダ行ってキャッシュ削除
import datetime
current_time = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')


# リスト合成####################################################################

# cost1 = [[[1, 2], [3, 4]], [[5, 6], [7, 8]]]
# cost2 = [[[9, 10], [11, 12]], [[13, 14], [15, 16]]]

# array1 = np.array(cost1)
# array2 = np.array(cost2)
# combined_array = np.concatenate((array1, array2), axis=0)
# combined_list = combined_array.tolist()

##############################################################################

#inc(1~11)+trans(0~8)コスト行列
foldername = 'kanen877'
cost = [[[9015179.901973303, 0, 533692.3115628922, 169092.3053423035, 0, 0], [6375927.721536702, 0, 553344.0583633254, 198932.62407958158, 0, 0], [4100188.6146611, 0, 575545.8637164412, 251970.8330324258, 0, 0], [2979718.8337468007, 0, 598435.678717803, 305716.4325820253, 0, 0], [2434289.6664103, 0, 621391.0680076589, 376322.193313915, 0, 0], [1889913.770022501, 0, 643237.8277553574, 422722.8353395552, 0, 0], [1492976.7889708006, 0, 659890.1974796681, 468055.29752240644, 0, 0], [1252632.0057566003, 0, 678699.5367681609, 521750.4634546727, 0, 0], [1083558.6466595, 0, 687969.0760224856, 543513.4105332847, 0, 0], [1001946.0532757002, 0, 697725.0731311662, 565510.2549865451, 0, 0], [896651.7432090001, 0, 714339.9898694521, 606311.5407089858, 0, 0]], [[5108678.148931402, 1509681.3104372602, 533692.3115628922, 169092.3053423035, 21711.39659063724, 22917.002518880265], [2832939.0420558, 1509681.3104372602, 555894.116916008, 222130.51429514773, 21711.39659063724, 22917.002518880265], [2605820.401257, 471947.2625744601, 576053.9103332944, 255354.7231861735, 17072.887655115628, 17578.88587029754], [2339569.6561524007, 144014.19786028002, 598417.2608455843, 305633.08308018395, 12732.066650757197, 12289.09093414572], [1810391.1554264007, 127796.350847, 620455.0592255169, 352828.4833872154, 12464.123179021797, 12211.16924978487], [1091486.9708162996, 453300.35836494016, 638045.3290785379, 421661.6117429066, 18259.43922590506, 18839.64479432239], [1192260.0584900999, 81029.39060226001, 659815.8303740143, 467650.2852331351, 10364.911269963075, 9629.921971419893], [1023186.699393, 81029.39060226001, 669085.369628339, 489413.23231174704, 10364.911269963075, 9629.921971419893], [943138.789247, 81029.39060226001, 678918.6439903319, 511626.2453633795, 10364.911269963075, 9629.921971419893], [871008.2468091, 33220.423210600005, 697725.0731311662, 565510.2549865451, 8901.14901254098, 8100.0350870924085], [783923.3211121, 33220.423210600005, 713507.9322023521, 606119.3400432762, 8901.14901254098, 8100.0350870924085]], [[2731059.9527559006, 1785091.2845330397, 533692.3115628922, 169092.3053423035, 36743.26847379434, 37952.36782593827], [1412322.6608186003, 1895041.0314147002, 555894.116916008, 222130.51429514773, 38466.28538358663, 39575.04048905359], [1486102.3218618005, 1117616.6935458607, 576203.2909154354, 256366.99335416796, 32746.630616721308, 32942.720862333255], [1393703.9416101002, 596301.6143299805, 598503.8934480743, 306225.33932894666, 30768.244115823916, 31117.104848048944], [1328996.4331138004, 246606.38185259994, 620083.3455988714, 351150.84581557324, 22330.25397340509, 21540.496130812135], [987530.9658190999, 345151.4242498, 637161.8825459044, 411746.79732279124, 26338.381968379377, 25163.86007788832], [933585.6480672, 205362.92964276005, 652558.6762877807, 444621.038757887, 20256.59236036126, 18988.39879497515], [833376.1980324999, 200188.43789364002, 669315.452568131, 485940.66079302074, 20219.379084128683, 18950.92839357119], [832218.7812290001, 110202.18130766001, 678399.3545003585, 508016.24651239096, 19871.251649298927, 18809.040277252203], [736328.8755099999, 88968.03114617999, 703751.9350936715, 584122.4955900158, 15050.29340063142, 14049.18157593215], [633512.8462419001, 111026.78211520003, 712991.3206655831, 604742.589008243, 20881.536635037777, 19292.12853231341]], [[1310443.5715187003, 2170451.00551048, 533692.3115628922, 169092.3053423035, 53498.157266743736, 54610.40579611159], [1823593.3214511008, 932009.1925369202, 554024.0164156192, 203482.26758192907, 45147.4305929255, 45061.47802303809], [979606.6962086998, 1108886.6349108403, 576312.454371225, 257112.73278353605, 48151.73617483511, 48854.12662988331], [857413.9818019996, 771352.9011598002, 598037.3596683573, 303916.52284915064, 40240.92656672824, 39512.06103459699], [958187.0694757997, 399081.93339712004, 620008.9784932175, 350745.8335263019, 32346.39861078625, 30302.338211694492], [801124.4453303, 376965.52623151994, 637161.8825459044, 411746.79732279124, 31500.888943853974, 30549.062501516026], [758996.8935013, 322461.28070574004, 646038.2327975956, 413840.7406107761, 32657.95196713559, 31132.947700828066], [782893.5681462, 143422.60451826005, 668643.3573916779, 486019.40205913037, 28772.400661839907, 26909.075364344608], [701280.9747624001, 143422.60451826005, 678399.3545003585, 508016.24651239096, 28772.400661839907, 26909.075364344608], [672515.8842117001, 106542.48219665998, 696942.4886371444, 562828.6997852469, 25748.858177428032, 23814.999184056484], [575590.5979055003, 129761.47104580002, 705190.995843436, 580846.461015739, 30189.92590277191, 27583.8473919339]], [[1284610.0806110003, 1676167.4471713593, 533692.3115628922, 169092.3053423035, 60522.625296968916, 60284.50378492281], [877727.6069087997, 1384296.6090066198, 554110.6490181092, 204074.52383069182, 63183.60805799223, 63889.49193694131], [585095.3930570999, 1134773.4974987002, 575828.1504510385, 253840.77946228534, 57374.06255160552, 57131.68193662468], [887648.1120753, 518059.3238549599, 598109.9641443683, 304619.06870838616, 47020.225149465616, 45113.73116541775], [761613.538853, 453301.01208645984, 616909.1717375597, 351479.3531415565, 41817.82085497714, 40869.01161762556], [627147.8529889, 487547.78586938, 627632.2142070377, 386649.45996823284, 45604.44225088344, 42893.81713640062], [765560.4067545, 175236.70649998004, 659373.8181373532, 464256.45498051855, 33934.9076373145, 32294.277787972318], [653686.5291603, 199170.2124538401, 668643.3573916779, 486019.40205913037, 34921.54504993035, 32858.22185318435], [576243.1259844004, 210790.86164806, 678133.3707668844, 507928.0744803645, 40554.83717273499, 37213.76936335379], [506428.2640724001, 219317.43649874008, 692770.2619535328, 544081.0986093222, 37696.697571664234, 34956.43144665403], [474579.5344400002, 210790.86164806, 691930.8236050678, 537724.575769717, 40554.83717273499, 37213.76936335379]], [[338744.36606869986, 2127828.8858890994, 533692.3115628922, 169092.3053423035, 78558.80276203564, 79112.51769882604], [667540.0722890998, 1266384.4236594404, 542167.1270323105, 169092.3053423035, 67745.79640999108, 66784.05821814621], [744758.0543667999, 793922.12808304, 564346.7167083658, 222201.88124622943, 59099.77476609238, 56415.99234742976], [646346.354091, 606114.6816608998, 598015.1439912969, 303987.8898002323, 51775.56697955596, 49557.70449361359], [630500.0171926001, 542101.66094042, 616588.6555169739, 354139.08945282036, 52456.83962869088, 51268.65592612627], [548820.5791318999, 461475.1473131201, 628922.4574085725, 369473.2501262913, 50753.88800266309, 47581.49160461921], [564085.4778344999, 336107.2761530999, 652116.6640511197, 441227.2085052704, 44813.22614032854, 42216.6986767396], [558323.3562188, 240275.65476080004, 670850.3822176156, 495456.34767808, 46995.35522874718, 43255.598346428385], [480784.76767250017, 252537.85970934006, 676155.3452152469, 503279.8128868815, 46597.84658420521, 43056.46653374644], [430919.2351528001, 234881.07141444006, 687585.8715865004, 530134.1080577425, 46867.46792269024, 43242.9560544958], [420306.10704600014, 220880.4615401401, 689800.6914147977, 530798.9651622538, 46761.332946070026, 43136.50673604871]], [[338744.36606869986, 1739566.0561591592, 533692.3115628922, 169092.3053423035, 84495.74068518763, 83480.986660402], [646839.1914323998, 1076719.2583393801, 542167.1270323105, 169092.3053423035, 74113.79398337984, 71428.18525032005], [550934.3402302, 850612.5605718401, 564346.7167083658, 222201.88124622943, 64370.18314022677, 61875.712212305174], [593756.0215101001, 659775.5649914999, 585922.6680391267, 265025.60268103564, 59415.4025821459, 57005.00617216883], [605708.2727520001, 417298.92991889996, 619649.9793845449, 347697.9650769507, 56237.0597574322, 53802.80896693528], [627021.8536973, 285471.63079101994, 639375.7156673111, 420302.0376362465, 51891.85308736517, 49240.36480779217], [438577.3336846001, 364596.5016306599, 659494.0171668604, 465269.56675381435, 54150.445224660536, 51242.56668246726], [407338.1592188001, 333932.82778826, 671337.9130650053, 497243.1434616205, 52543.382131215796, 48920.6573954709], [426941.2683928001, 229648.32788510012, 687796.8196134995, 541775.3727980598, 47543.011694034634, 44898.68499879813], [382739.7048766001, 254930.11055178003, 682267.2309983723, 513976.4797298936, 51758.778575907265, 48579.460481378286], [361875.75665699993, 228295.74178222002, 695132.2835155894, 546750.5993628231, 49474.53115509653, 47352.49635015101]], [[318043.4852119999, 1537297.3661803394, 533692.3115628922, 169092.3053423035, 90863.7382585764, 88125.11369257585], [407620.185405, 1106784.7161626804, 553531.3039124779, 200170.33422018134, 82852.51586411364, 80812.81968109791], [427413.7274114001, 858956.65327536, 564346.7167083658, 222201.88124622943, 73163.43075410795, 69901.22985814986], [429286.96880410006, 716966.5381526402, 580858.3254653822, 254167.75483142474, 74411.6300082106, 71880.59702711899], [494382.01649670006, 484136.60534872, 607326.454496935, 326021.32260218274, 66985.93847225183, 62843.561179139615], [353364.17365240003, 508600.6930025599, 629035.6047770277, 370456.7753872238, 69006.13368094312, 64671.447031156495], [366316.1806014001, 410180.89929166005, 648969.6221961093, 429594.20541388047, 65427.08334050019, 61342.15689874325], [366569.32112630014, 325104.77870934, 668355.4447083168, 485315.163210404, 57907.922963997706, 54528.606970218025], [364683.9560856001, 263007.31689320004, 678213.1002086406, 507746.2488756547, 56118.63174621153, 53526.11522433864], [339444.8450873, 289510.4755866601, 669772.3631031812, 490101.56893407565, 61925.88586979111, 57955.42840558049], [330457.33487990004, 233027.00005756013, 685701.2846434615, 529197.378135439, 56852.85134158507, 53833.131266408964]], [[318043.4852119999, 1379910.3698944398, 533692.3115628922, 169092.3053423035, 95349.4872599229, 93067.98819324911], [331577.6164339001, 1083748.20854036, 553626.3450979227, 200802.57050944108, 92160.83002203886, 89854.08386362217], [393182.2567465, 804494.0476463999, 564420.8634566178, 222201.8812462294, 79908.89755078153, 76091.20852552773], [433568.5548058001, 658655.0402155799, 590177.8792926739, 251764.66773821862, 75646.03727097542, 72336.69846891236], [301390.8574033, 699935.1896604601, 591044.9962861618, 273608.15388682485, 80643.25807180686, 76574.68431699932], [403690.1656382002, 377209.35711116, 642188.7467767801, 417073.5814862132, 68835.4042241401, 64299.90943261799], [276968.2698005, 436707.2076258799, 651827.9817969834, 440519.770371533, 67819.74298713863, 63897.15326014465], [356467.7047604001, 322611.6685228, 660152.0839175363, 457559.87834652734, 66858.40201029452, 63334.248553640406], [363880.8556136002, 257248.84982932007, 675492.6972694076, 501145.23915325105, 57090.36891521313, 54632.281592949024], [271286.26888769993, 292329.05385068007, 681937.1836366454, 513184.3725834999, 60937.41968841071, 58803.826578451924], [301889.2762358, 228672.29121990004, 688823.9225918693, 527304.8033002927, 60717.16010759141, 57925.37940502858]]]

# cost = combined_list

horizon = "inc"
horizon = "trans"

##############################################################################

def bar_chart(cost_per_, N_START, filename):
    # コストデータを億単位に変換
    cost_per_ = cost_per_ / 1e4
    
    TC_direct = cost_per_[:, 0]
    TC_indirect = cost_per_[:, 1]
    IC_inc = cost_per_[:, 2]
    OC_inc = cost_per_[:, 3]
    IC_trans = cost_per_[:, 4]
    OC_trans = cost_per_[:, 5]

    plt.figure(figsize=(12, 6))
    N_FACILITY = np.arange(cost_per_.shape[0]) + N_START
    plt.xticks(N_FACILITY)
    plt.bar(N_FACILITY, TC_direct, color='blue', label='TC_direct')
    plt.bar(N_FACILITY, TC_indirect, bottom=TC_direct, color='blue', linestyle='--', label='TC_indirect')
    plt.bar(N_FACILITY, IC_inc, bottom=TC_direct + TC_indirect, color='orange', label='IC_inc')
    plt.bar(N_FACILITY, OC_inc, bottom=TC_direct + TC_indirect + IC_inc, color='orange', linestyle='--', label='OC_inc')
    plt.bar(N_FACILITY, IC_trans, bottom=TC_direct + TC_indirect + IC_inc + OC_inc, color='yellow', label='IC_trans')
    plt.bar(N_FACILITY, OC_trans, bottom=TC_direct + TC_indirect + IC_inc + OC_inc + IC_trans, color='yellow', linestyle='--', label='OC_trans')

    # 同色間点線の描画
    for x in range(cost_per_.shape[0]):
        adjusted_x = x + N_START  # 調整されたインデックス
        plt.hlines(TC_direct[x], adjusted_x - 0.4, adjusted_x + 0.4, colors='black', linestyles='dotted')
        plt.hlines(TC_direct[x] + TC_indirect[x] + IC_inc[x], adjusted_x - 0.4, adjusted_x + 0.4, colors='black', linestyles='dotted')
        plt.hlines(TC_direct[x] + TC_indirect[x] + IC_inc[x] + OC_inc[x] + IC_trans[x], adjusted_x - 0.4, adjusted_x + 0.4, colors='black', linestyles='dotted')

    # 凡例
    handles, labels = plt.gca().get_legend_handles_labels()
    # plt.legend(handles[::-1], labels[::-1], loc='upper left', bbox_to_anchor=(1.05, 1))        
    plt.legend(handles[::-1], labels[::-1], loc='lower left', bbox_to_anchor=(1, 0.4))        

    # ラベル
    plt.xlabel(xlabel)
    plt.ylabel('Cost (億円)')
    plt.title(f'Stacked Bar Chart for {title_suffix}')
    plt.tight_layout(rect=[0, 0, 0.85, 1])
    
    # ファイルに保存
    plt.savefig(filename)
    plt.close()  # グラフを閉じる

if horizon == "inc":
    save_folder = f"graphs_{str(foldername)}_INC_{current_time}"
    if not os.path.exists(save_folder):
        os.makedirs(save_folder)
    for N_TRANS in range(len(cost)):
        cost_per_inc = np.array(cost[N_TRANS])
        title_suffix = f'N_TRANS = {N_TRANS}'
        xlabel = 'N_INC'
        filename = os.path.join(save_folder, f'TRANS{N_TRANS}.png')
        bar_chart(cost_per_inc, 1, filename)

if horizon == "trans":
    save_folder = f"graphs_{str(foldername)}_TRANS_{current_time}"
    if not os.path.exists(save_folder):
        os.makedirs(save_folder)
    transposed_cost = np.transpose(cost, (1, 0, 2))
    for N_INC in range(len(transposed_cost)):
        cost_per_trans = np.array(transposed_cost[N_INC])
        title_suffix = f'N_INC = {N_INC+1}'
        xlabel = 'N_TRANS'
        filename = os.path.join(save_folder, f'INC{N_INC+1}.png')
        bar_chart(cost_per_trans, 0, filename)

import os
import matplotlib.pyplot as plt
import numpy as np

import matplotlib
matplotlib.rcParams['font.family'] = 'TakaoPGothic' # takao インストール後、matplotlibのフォルダ行ってキャッシュ削除
import datetime
current_time = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')

##############################################################################

#inc(1~10)+trans(0~8)コスト行列
foldername = "kanen300"
cost = [[[3083869.9778700015, 0, 329899.8818864615, 138135.64307217477, 0, 0], [2181047.11113, 0, 342047.53477158566, 162512.92984408402, 0, 0], [1423045.0412100002, 0, 355771.4966967819, 205841.14094314096, 0, 0], [1019288.0845199999, 0, 369920.74918130506, 249747.23673534326, 0, 0], [831602.9737199997, 0, 383553.5011646385, 288363.6782075949, 0, 0], [646492.7377499996, 0, 397615.02799237816, 345332.6310899478, 0, 0], [510710.41811999993, 0, 407908.6272932413, 382365.82904059737, 0, 0], [452874.60542999994, 0, 413638.55788974615, 400144.51319635514, 0, 0], [370658.6020500001, 0, 425265.47976063576, 444009.4085321045, 0, 0], [342740.9532300001, 0, 431296.1124381296, 461979.1691782713, 0, 0]], [[1757726.8714800007, 653047.6496040002, 329899.8818864615, 138135.64307217477, 13127.840423039623, 58288.53559361692], [1369567.9353300005, 198615.18181799995, 342047.53477158566, 162512.92984408402, 7653.720155424562, 32839.53822058704], [898277.2493099999, 212833.15574399996, 356077.1960905506, 208531.12068446877, 9157.138272498982, 39127.985568270626], [807230.23752, 72377.49260400001, 369930.34316077264, 249804.62331635624, 5600.18903155925, 23287.007124821535], [628436.3401199997, 63805.27722, 383562.73598675954, 288418.8254328009, 5451.628113271557, 22455.406832247816], [480837.61049999995, 63101.13639, 397689.6605675343, 345757.0228505315, 3783.7061562212066, 15407.239594273648], [407842.66539000004, 40451.215806, 407862.65754842793, 382034.964588088, 4136.823864357744, 17108.77428500937], [350006.85270000005, 42799.963242, 413592.58814493276, 399813.64874384576, 4136.823864357744, 17108.77428500937], [322624.44330000004, 40451.215806, 419670.98946399766, 417960.00280913746, 4136.823864357744, 17108.77428500937], [298485.60891000007, 16034.235779999997, 431343.88107970066, 462155.7625973962, 3125.252963120106, 12753.968382721265]], [[938240.6012999999, 872903.52243, 329899.8818864615, 138135.64307217477, 20907.18417737554, 91948.84179969586], [595152.83157, 766391.0188980001, 335182.88359190756, 138135.64307217475, 20266.957902075734, 88534.38099941198], [715591.19562, 275802.8455560001, 356063.4635538821, 208589.42209364177, 13571.176271283179, 57175.55384869469], [624544.1838299996, 135347.182416, 369916.6106241041, 249862.92472552924, 10014.227030343447, 41334.575405245596], [463084.1681699998, 126326.295336, 383348.4548067998, 287140.8715468323, 9224.121428386916, 37852.728926500975], [377969.85777000006, 103552.35219599999, 397643.6908227209, 345426.1583980221, 7920.530020578951, 32516.01387928302], [344250.8780700001, 59910.97127400001, 407862.65754842793, 382034.964588088, 5216.916765495975, 21958.982198862403], [305216.26896, 56485.451586, 413592.58814493276, 399813.64874384576, 7262.07682747785, 29862.742667730636], [284537.3523, 37001.287152000004, 425265.47976063576, 444009.4085321045, 4580.2409820599305, 19279.196054022847], [271633.4784, 56485.451586, 421472.00354839355, 421480.73579928343, 7262.07682747785, 29862.742667730636]], [[459300.7280700001, 1037365.3106820001, 329899.8818864615, 138135.64307217477, 29690.506046134167, 129311.35851722816], [638353.8811200002, 500674.10414400016, 342453.92090568977, 166104.26081483933, 22696.245756104458, 97617.73102188503], [590054.8067099999, 314379.11901599995, 348749.7241836083, 181463.85417123168, 14886.15448188999, 61895.302147001195], [459192.0118799998, 197868.2005319999, 369695.38352309423, 248541.4158799175, 13786.752096069124, 56731.89750076878], [329351.85942, 199349.58910800004, 383269.4463932345, 286611.7406781414, 13327.012857543617, 54932.03203448691], [314378.07045000006, 123012.10766400001, 397643.6908227209, 345426.1583980221, 9000.622921717182, 37366.22179313605], [299460.29433, 75945.207054, 407862.65754842793, 382034.964588088, 8342.169728616082, 34712.95058158367], [263885.60295000003, 77452.50295800001, 413592.58814493276, 399813.64874384576, 8717.064846417676, 36387.97033903222], [253889.29554, 66193.7925, 419594.5332619477, 417553.1598894266, 8306.418417272671, 34687.418018928474], [256766.88861000002, 77452.50295800001, 416389.3727471216, 405029.16540688457, 8717.064846417676, 36387.97033903222]], [[449338.4623500001, 886339.8195600003, 329899.8818864615, 138135.64307217477, 30772.912286084, 131542.99616361473], [455177.34423, 563643.7939560001, 342453.92090568977, 166104.26081483933, 27110.283754888653, 115665.29930230911], [328428.4665299999, 417142.9296779999, 355873.5092874289, 206910.55806134982, 22513.71581122092, 94064.9421442489], [286443.92501999997, 289632.779934, 369674.28943118, 248415.60272399426, 20348.550324203825, 84395.23064119107], [296624.62811999995, 186237.26660999993, 383301.85138353537, 286806.28875932534, 14441.038193882892, 59811.71112536338], [269587.48670999997, 139046.343444, 397643.6908227209, 345426.1583980221, 12125.875884837289, 50120.190175857315], [258129.62832, 96912.25842600001, 407862.65754842793, 382034.964588088, 9797.157747555906, 41238.17825288525], [239941.03892999998, 87160.84387200001, 413516.13194288284, 399406.8058241349, 9761.406436212495, 41212.645690230056], [228847.01157, 82356.45631200001, 418082.34602468944, 412660.2361580305, 9627.568206956084, 40397.99640793376], [205642.21098000006, 79973.26026, 421833.84247005434, 419998.60004785494, 11846.167123931134, 49188.21844942468]], [[449338.4623500001, 758871.3829860003, 329899.8818864615, 138135.64307217477, 31465.191065471285, 132943.02385476592], [373873.13285999984, 575963.9906460001, 335025.76225841214, 138135.64307217475, 26953.91263609875, 112782.4086480123], [258061.5951599999, 444094.37595600006, 348848.7863725995, 181522.15558040468, 26042.10043166236, 108467.27494209947], [210421.42523999995, 327856.70980199997, 369698.19258037716, 248625.85125288897, 22192.305245922886, 92727.28397604544], [265760.0721, 198541.11789, 383269.4463932345, 286611.7406781414, 14819.352828961873, 61182.25643822275], [228256.82069999995, 160013.39481599996, 397643.6908227209, 345426.1583980221, 13580.863903777114, 56645.4178471589], [234185.06430000003, 106620.59934, 407786.20134637796, 381628.12166837713, 10841.499337350726, 46062.85360408309], [202978.58781000003, 100940.31163200001, 413234.32444349915, 396584.46904585505, 13301.155142870959, 55713.446120726265], [186870.39189000006, 90951.88523999999, 419318.4795313576, 415657.61545337026, 14008.465770935967, 56950.19086739796], [176120.99787000008, 90951.88523999999, 421887.3648804189, 421101.98580920324, 14008.465770935967, 56950.19086739796]], [[266161.92545999994, 821841.0727980002, 329899.8818864615, 138135.64307217477, 35879.22906425548, 150990.59213518997], [224565.97499999995, 642709.5577740001, 335138.5569840718, 138135.64307217475, 33695.82058708693, 141306.8131626865], [194469.80783999994, 463554.131424, 348848.7863725995, 181522.15558040468, 27122.19333280059, 113317.48285595249], [210421.42523999995, 290727.471882, 369698.19258037716, 248625.85125288897, 22816.98431162467, 94127.30896320808], [220969.48835999996, 214575.35366999992, 383269.4463932345, 286611.7406781414, 17944.60579208198, 73936.22482094401], [226552.05473999996, 148572.2292, 397555.57737273624, 344935.95250837936, 13889.622152305075, 58776.30669118747], [197222.61318000007, 120400.0671, 407504.39384699427, 378805.7848900973, 14381.24804400919, 60563.6540345793], [173457.37470000004, 112373.40034200001, 413287.8468538637, 397687.85480720346, 15463.453789875792, 63475.418538699545], [196102.89339000007, 92787.37352399998, 415083.107169466, 400281.7954551259, 13527.113104529684, 57858.82039466117], [155816.99918999994, 98210.221674, 421736.38134719356, 420098.0182014087, 15295.247032820065, 62635.658751251176]], [[116854.76759999998, 888376.4102580004, 329899.8818864615, 138135.64307217477, 42621.168224957546, 179514.99665111257], [160974.18767999997, 662169.3132420002, 335138.5569840718, 138135.64307217475, 34775.91348822516, 146157.02107653953], [181732.73708999995, 445189.06790400005, 348894.6199043193, 181522.15558040468, 28514.489608165364, 118199.35342232406], [233555.99594999992, 250669.1106719999, 369802.04361704004, 249542.29751742576, 23337.41585392233, 96388.3939503328], [218462.44559999998, 203444.682054, 383476.2840712979, 287845.46995621733, 18268.602971534063, 76080.05567507776], [202607.49072, 158280.57011399994, 397479.12117068627, 344529.1095886685, 14933.963742099895, 63600.98204238531], [196012.06050000008, 112247.12899199997, 407504.39384699427, 378805.7848900973, 14607.206005667915, 62709.0283085142], [172246.82202000005, 103765.99850399997, 413287.8468538637, 397687.85480720346, 15689.411751534517, 65620.79281263445], [161152.79466000007, 98507.14721399998, 417862.6860087391, 410992.3965303526, 15555.573522278106, 64806.14353033815], [155816.99918999994, 89528.998962, 421736.38134719356, 420098.0182014087, 15645.950143244285, 64035.67277937559]], [[116854.76759999998, 841741.5842880002, 329899.8818864615, 138135.64307217477, 43010.335617992765, 181615.01221780828], [133194.97604999997, 618522.9388260002, 342187.33956840786, 163735.28400329177, 38689.26777819707, 162410.7709509851], [179206.45812, 381663.3852479999, 355955.93451302114, 207635.8601343522, 32122.59414190911, 133583.37587198487], [188765.41221, 266703.3464519999, 369802.04361704004, 249542.29751742576, 26462.66881704244, 109142.36233305407], [160062.47322000004, 238063.16234399998, 383063.100310675, 284217.6263769787, 22528.696088535267, 93261.70060263805], [165645.03960000005, 174253.59197399992, 397190.40969037206, 341668.3911814955, 18477.48527519583, 78101.78262379456], [166490.84739000007, 123225.75397199996, 407591.8879983153, 380096.6816024095, 16769.504652672746, 70471.00072648749], [153153.37601999994, 110496.05033400001, 413136.86332063837, 396683.8871994088, 17100.93816218411, 70560.90045067716], [149965.57272, 108988.75442999999, 416177.6163760104, 402985.0047789125, 16726.043044382517, 68885.88069322862], [138891.18026999995, 95638.26441599999, 421777.5640289634, 420330.4653667365, 16313.328625280425, 67893.7683342409]]]
horizon = "inc"
horizon = "trans"

##############################################################################

def bar_chart(cost_per_, N_START, filename):
    # コストデータを億単位に変換
    cost_per_ = cost_per_ / 1e4
    
    TC_direct = cost_per_[:, 0]
    TC_indirect = cost_per_[:, 1]
    IC_inc = cost_per_[:, 2]
    OC_inc = cost_per_[:, 3]
    IC_trans = cost_per_[:, 4]
    OC_trans = cost_per_[:, 5]

    plt.figure(figsize=(12, 6))
    N_FACILITY = np.arange(cost_per_.shape[0]) + N_START
    plt.xticks(N_FACILITY)
    plt.bar(N_FACILITY, TC_direct, color='blue', label='TC_direct')
    plt.bar(N_FACILITY, TC_indirect, bottom=TC_direct, color='blue', linestyle='--', label='TC_indirect')
    plt.bar(N_FACILITY, IC_inc, bottom=TC_direct + TC_indirect, color='orange', label='IC_inc')
    plt.bar(N_FACILITY, OC_inc, bottom=TC_direct + TC_indirect + IC_inc, color='orange', linestyle='--', label='OC_inc')
    plt.bar(N_FACILITY, IC_trans, bottom=TC_direct + TC_indirect + IC_inc + OC_inc, color='yellow', label='IC_trans')
    plt.bar(N_FACILITY, OC_trans, bottom=TC_direct + TC_indirect + IC_inc + OC_inc + IC_trans, color='yellow', linestyle='--', label='OC_trans')

    # 同色間点線の描画
    for x in range(cost_per_.shape[0]):
        adjusted_x = x + N_START  # 調整されたインデックス
        plt.hlines(TC_direct[x], adjusted_x - 0.4, adjusted_x + 0.4, colors='black', linestyles='dotted')
        plt.hlines(TC_direct[x] + TC_indirect[x] + IC_inc[x], adjusted_x - 0.4, adjusted_x + 0.4, colors='black', linestyles='dotted')
        plt.hlines(TC_direct[x] + TC_indirect[x] + IC_inc[x] + OC_inc[x] + IC_trans[x], adjusted_x - 0.4, adjusted_x + 0.4, colors='black', linestyles='dotted')

    # 凡例
    handles, labels = plt.gca().get_legend_handles_labels()
    # plt.legend(handles[::-1], labels[::-1], loc='upper left', bbox_to_anchor=(1.05, 1))        
    plt.legend(handles[::-1], labels[::-1], loc='lower left', bbox_to_anchor=(1, 0.4))        

    # ラベル
    plt.xlabel(xlabel)
    plt.ylabel('Cost (億円)')
    plt.title(f'Stacked Bar Chart for {title_suffix}')
    plt.tight_layout(rect=[0, 0, 0.85, 1])
    
    # ファイルに保存
    plt.savefig(filename)
    plt.close()  # グラフを閉じる

if horizon == "inc":
    save_folder = f"graphs_{str(foldername)}_INC_{current_time}"
    if not os.path.exists(save_folder):
        os.makedirs(save_folder)
    for N_TRANS in range(len(cost)):
        cost_per_inc = np.array(cost[N_TRANS])
        title_suffix = f'N_TRANS = {N_TRANS}'
        xlabel = 'N_INC'
        filename = os.path.join(save_folder, f'TRANS{N_TRANS}.png')
        bar_chart(cost_per_inc, 1, filename)

if horizon == "trans":
    save_folder = f"graphs_{str(foldername)}_TRANS_{current_time}"
    if not os.path.exists(save_folder):
        os.makedirs(save_folder)
    transposed_cost = np.transpose(cost, (1, 0, 2))
    for N_INC in range(len(transposed_cost)):
        cost_per_trans = np.array(transposed_cost[N_INC])
        title_suffix = f'N_INC = {N_INC+1}'
        xlabel = 'N_TRANS'
        filename = os.path.join(save_folder, f'INC{N_INC+1}.png')
        bar_chart(cost_per_trans, 0, filename)
